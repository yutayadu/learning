# 第2章 Oracleソフトウェアのインストールとデータベース作成
# 2-1 Oracle ソフトウェアのインストール
- **Oracle Universal Installer (OUI)** を使用してOracleソフトウェアをインストールする

## 2-1-1 Oracleソフトウェアインストールの全体像
- 流れ
    - 前提条件の確認
    - OSへの設定(OSユーザ、OSグループ、環境変数)
    - Oracleソフトウェアのインストール
    - Oracleデータベースの作成
## 2-1-2 前提条件の確認
- サポートされているOSバージョンであること
- 記憶域の空き容量が十分にあること
- 物理メモリサイズが十分にあること(1GiB以上)
- インストールに使用するOSユーザおよびグループが存在すること
## 2-1-3 OSへの設定
### OSユーザーとOSグループを作成する
- Oracleソフトウェアのインストールの前に、OSユーザ(**Oracleソフトウェア所有者**)を作成

    | OSユーザ | 説明 |
    | --- | --- |
    | **Oracleソフトウェア所有者** | Oracleをインストールおよび管理するOSユーザ。後述するOracleインベントリグループ、OSDBAグループに所属する。通常、ユーザ名は"**oracle**"とする |

    | OSグループ | 説明 |
    | --- | --- |
    | **Oracleインベントリグループ** | Oracleに関連するファイルを所有するOSグループ。通常、グループ名は"**oinstall**"とする |
    | **OSDBAグループ** | Oracleの管理権限が付与されるOSグループ。通常、グループ名は"**dba**"とする |
    | ( OSOPERグループ ) | SYSOPER管理権限(oper)、データベース管理権限の一部を持つ |
    | ( OSBACKUPDBAグループ ) | バックアップおよびリカバリ(backupdba) |
    | ( OSDGDBAグループ ) | Data Guard(dgdab) |
    | ( OSKMDBAグループ ) | 暗号化鍵関連/SYSKM管理(kmdba) |
    | ( OSRACDBAグループ ) | RAC関連(racdba) |
### 作成したOSユーザーに環境変数を設定する
- Oracleソフトウェア所有者の環境変数に、Oracleインスタンスの識別子やインストール先ディレクトリなどのOracleの実行環境に関する情報を設定

    | 環境変数 | 説明 |
    | --- | --- |
    | ORACLE_BASE | Oracle関連ファイルの基準となるディレクトリのパスを設定する。<br>データベースファイルやログファイルなどの、<br>Oracleに関連するほとんどのファイルがORACLE_BASE以下に配置される |
    | ORACLE_HOME | Oracleのソフトウェアを配置するディレクトリのパスを設定する。<br>ORACLE_HOMEは、ORACLE_BASEのサブディレクトリに指定する |
    | ORACLE_SID | インスタンスの識別子であるSID(システム識別子)を設定する。<br>この環境変数により、接続先インスタンスが識別される。<br>原則的に「インスタンスのSID＝データベース名」の関係が成り立つ |
    | LD_LIBRARY_PATH | Oracleが使用する共有ライブラリの場所を指定する |

### ORACLE_SIDとデータベース名の関係
- **環境変数ORACLE_SID**には、インスタンスの識別子である**SID**を設定する
- DBCAを用いたデータベースの作成では、データベースの識別子として、**データベース名**を指定する
- 通常の構成では、インスタンスとデータベースファイルは１対１に対応し、原則的には「SID=データベース名」の関係が成り立つ。
- **Optimal Flexible Architecture (OFA)**
    - データベース・ソフトウェアとデータベースの配置、構成に関する推奨のガイドライン

## 2-1-4 OUIによるOracleソフトウェアのインストール
- Oracle Universal Installer (OUI)を使用して以下を実施(=GUI)
    - Oracleソフトウェアのインストール
    - インストールされているOracle製品の一覧表示
    - インストール前の前提条件のチェック
    - 使用しないOracle製品の削除

- OUIでOracle Databaseをインストールする場合、対話形式のインストール、またはレスポンス・ファイルを使用した非対話形式の自動インストールのどちらかの方法でインストールを行います。
    - 非対話形式のインストールでは、Oracle Databaseのインストールに必要な情報をレスポンス・ファイルに記述し、OUI起動時にレスポンス・ファイルを指定することで、インストールのすべての手順、または一部を自動化できます。
        ```bash
        ./runInstaller -responseFile レスポンス・ファイル名
        ```

### 補足 OSの設定
```bash
# OUIを起動する上でGUI環境を用意する必要がある
yum groupinstall "Server with GUI"
systemctl set-default graphical.target
```
```bash
# あるいはxmingを利用するか
$ sudo yum install xorg-x11-xauth
$ sudo yum install xterm
$ xauth list
$ xauth add ---
$ export DISPLAY=localhost:10.0

# Teratermのメニューから「設定」⇒「SSH転送」
# 新しいセッションでログイン(ORACLEユーザ)

# Xmingのインストール先フォルダのX0.hostsファイルでX Windowの転送を許可するサーバ（XWindowを転送するサーバ）のIPアドレスを記入します。
# sshd_config内に「X11Forwarding yes」
```

### ① ORACLE_HOMEにインストールファイルを展開する
- ORACLE_HOMEに対応するディレクトリにインストールファイルを展開する
    ```bash
    mkdir -p /u01/app/oracle/product/19.0.0/dbhome_1
    chown -R oracle:oinstall /u01/app
    # scp転送などでインストールファイルをoracleユーザのホームディレクトリ下に配置

    cd /u01/app/oracle/product/19.0.0/dbhome_1
    unzip ~/LINUX.X64_193000_db_home.zip
    ```
### ② OUIの起動まで
- ORACLE_HOMEディレクトリにあるrunInstallerを実行し、OUIを起動する
    ```bash
    ./runInstaller
    ```

### ③ 構成オプションの選択
- Oracleのインストールだけを行うか　（〇）
- インストールと同時にデータベースを作成するか
- （いったん、ソフトウェアのみの設定をします）

### ④ インストールオプションの選択
- 次へ
    - 単一インスタンス・データベースのインストール　（〇）
    - Oracle Real Application Clusterデータベースのインストール

### ⑤ データベースエディションの選択
- 次へ
    - Enterprise Edition　（〇）
    - Standard Edition 2

### ⑥ インストール場所の指定
- Oracleベース 
    - **環境変数ORACLE_BASE**に設定したディレクトリパスを指定
    - /u01/app/oracle
- ソフトウェアの場所
    - runInstallerを起動した**ORACLE_HOME**のディレクトリパスが表示

### ⑦ インベントリの作成
- インベントリディレクトリ
    - そのマシンにインストールしたOracle製品の情報を記録するディレクトリ
    - パッチ適用、アップグレードや削除のために利用する
    - つまり
        - Oracleソフトウェアを初めてインストールする時に作成される
        - 同一マシン上のすべてのOracleソフトウェアで共有される
        - Oracleソフトウェアやパッチのメタデータの格納場所である
-  Oracleインベントリグループ
    - Oracleインベントリグループとして作成したOSグループ（通常**oinstall**）

### ⑧権限のあるオペレーティング・システム・グループ
- インストール前に作成したosグループを指定

### ⑨ rootスクリプトの実行構成
- [構成スクリプトを自動的に実行]を選択すると、以下のスクリプトがrootユーザで実行される

    | スクリプト名 | 実行結果 |
    | --- | --- |
    | orainstRoot.sh | インベントリポインタファイル(/etc/orainst.loc)が作成される。<br>インベントリポインタファイルには、インベントリ(インストールしたOracleソフトウェア)の場所と管理グループが記録される |
    | root.sh | oraenvスクリプトとcoraenvスクリプト、dbhomeスクリプトが指定したディレクトリにコピーされる。<br>また、/etc/oratabファイルが作成または編集される |

### ⑩ 前提条件チェックの実行
- 前提条件が満たされているかがチェックされ、結果が表示される

### ⑪ サマリー
- これまで入力した項目のサマリーが表示される

### ⑫ 製品のインストール
- インストールの進捗状況が表示される

### ⑬ 構成スクリプトの実行の確認
- 「構成スクリプトを自動的に実行」を選択しなかった場合、rootスクリプトの実行が促されるので、rootユーザーで表示されたrootスクリプトを実行し、実行したら、[OK]を押します。

# 2-2 Oracleデータベースの作成
## 2-2-1 Database Configuration Assistant (DBCA)
- OUIを使用したソフトウェアのインストールが完了したら、データベースを作成する
- データベースを作成するには、**Oracle Database Configuration Assistant**を利用する
    ```bash
    export ORACLE_BASE=/u01/app/oracle
    export ORACLE_HOME=/u01/app/oracle/product/19.0.0/dbhome_1
    export NLS_LANG=Japanese_Japan.AL32UTF8
    export PATH=$ORACLE_HOME/bin:$PATH

    dbca
    ````

## 2-2-2 DBCAを使用したデータベースの作成
### ① データベース操作の選択
- データベースの作成（〇）
- テンプレートの管理

### ② データベース作成モードの選択
- 標準構成
    - 一般的な構成
- 拡張構成
    - 記憶域の場所、初期化パラメータ、管理オプション、データベースオプション、管理用ユーザのパスワード、サンプルスキーマ、メモリー管理方式などのカスタマイズ
- 標準構成の項目
    | 項目 | 説明 | DBCAでの入力例 |
    | --- | --- | --- |
    | グローバル・データベース名 | データベースを識別する名前 | orcl.us.oracle.com |
    | 記憶域タイプ | データベースファイルをどの記憶域に配置するかを指定する(ディレクトリパス・ASMディスクグループ) | [ファイルシステム ] |
    | データベース・ファイルの位置 | 記憶域タイプの選択によって変わる | {ORACLE_BASE}/oradata/{DB_UNIQUE_NAME} |
    | 高速リカバリ領域 | バックアップおよびリカバリの領域を指定 | {ORACLE_BASE}/fast_recovery_area/{DB_UNIQUE_NAME} |
    | データベース文字セット | データベースに使用するキャラクタセットを選択 | AL32UTF8 |
    | 管理者パスワード | SYS,SYSTEMなどのパスワードを入力する | 非表示 |
    | コンテナ・データベースとして作成 | マルチテナントコンテナベースとする場合 | 未チェック |
    - ASM (Automatic Strage Management : 自動ストレージ管理)
        - Oracleのボリュームマネージャ兼ファイルシステム
    - マルチテナントコンテナデータベース
        - 1つのデータベースの中に複数の仮想的なデータベース(プラガブルデータベース)を持つことができる構成

### ③サマリー
- 入力項目のサマリー

### ④進行状況ページ
- 進行状況ページ
    - DBCAログファイルの場所
    - グローバルデータベース名、SIDおよびデータベースのサーバーパラメータファイル名

## Oracle_HOMEとデータベース
- 1つのORACLE_HOMEには、特定のリリースのOracleソフトウェアしか存在できない（18cと19cは同居できない）
- あるデータベースは特定のORACLE_HOMEと関連している。リリースは共通。
- 同一データベースサーバーに複数のORACLE_HOMEを作成できる。ただし、ORACLE_HOMEは別にする必要がある
- あるORACLE_HOMEに関連するデータベースは複数作成可能。

# 2-2-3 テンプレートの管理
### テンプレートとは
- DBCAでデータベースを作成するときのひながた
- データベースオプション、初期化パラメータ、記憶域属性(データファイル、表領域、制御ファイルおよびREDOログの属性)
- 実体としてはXMLファイル
- \<ORACLE_HOME>/assistants/dbca/templatesに格納される

### テンプレートの種類
- テンプレートの種類
    | 種類 | 説明 |
    | --- | --- |
    | シード | テンプレートにデータファイルが含まれる。<br>シードデータベースの複製として、データベースにを作成する。<br>作成するデータベースの構成はシードデータベースに準ずるものになる。|
    | 非シード | テンプレートにデータファイルが含まれない。作成するデータベースは柔軟に構成できる |

- シードテンプレートをもとにしたデータベースの作成で変更できるもの
    - データベースの名前
    - データファイルの格納先 
    - 制御ファイルの数
    - REDOロググループの数
    - 初期化パラメータ

### テンプレートの作成
- テンプレート作成のオプション
    | オプション | 説明 |
    | --- | --- |
    | 既存のテンプレートからテンプレートを作成 | 柔軟 |
    | 既存のデータベースからテンプレートを作成 | ユーザ定義スキーマやデータは含まれない |
    | 既存のデータベースからテンプレートを作成、<br>データファイルを含める | もとのデータベースはローカルにある必要がある |

### データベースのアップグレードについて
- **Oracle Database Upgrade Assistant(DBUA)**を実行してアップグレードする
    - DBUAを用いてアップグレード可能なリリースには制限がある



# DB接続
```bash
export ORACLE_SID=orcl

sqlplus
system / system
SELECT table_name FROM user_tables;
```


# 最強問題集
>DBCAでデータベースを作成する際に、すべてのデータベース・ファイルに対して「Oracle Managed Filesの使用」を適用
- Oracle Managed Filesの使用: このオプションにチェックを付けると、データベースを構成するOSファイルをOracle Databaseが管理する。データベース管理者はファイル名やサイズを指定する必要はない

>DBCAで行えない作業
- Enterprise Manager Cloud Controlの管理エージェントをインストールする

>データ・ブロックのサイズを16Kに設定するなどいくつかの初期化パラメータを変更し、データファイルを追加してデータベースを作成します。
DBCAでどのテンプレートを使用すれば良いですか。
- カスタム・データベース

    | テンプレート | 説明 |
    | --- | --- |
    | 汎用またはトランザクション処理 | 同時大量のトランザクションを想定。可用性、速度。同時実行性、リカバリ能力 |
    | カスタム。データベース | あらゆる設定を変更できる。非シード |
    | データウェアハウス | 複雑なSQLで、大量のデータを処理。シードテンプレート。応答時間、精度、可用性 |

>Oracle Automatic Storage Management
- Oracle Automatic Storage Management(Oracle ASM)は、データベース・ファイルのボリューム・マネージャ及びファイルシステムです。ASMにより自動管理されるディスク・グループ(ディスクの集合)上にデータベースを構築します。  
Oracle社のストレージ管理ソリューションであり、従来のボリューム・マネージャやファイルシステム、RAWデバイス(ファイルシステムを使用しない記録デバイス)に代わるものです。

>Database Configuration Assistantでデータベースを作成する際の説明
- 10. [構成オプションの指定]画面の[接続モード]タブ: 専用サーバー・モードまたは共有サーバー・モードのどちらかを選択する
- 11. [管理オプション]画面では、作成するデータベースを、Enterprise Manager管理ツールで管理できるように設定します。
    - Enterprise Manager(EM) Data Express: 1つのデータベースを簡易的に管理する
    - Enterprise Manager(EM) Cloud Control: 複数のデータベースを集中管理する
- 12. [データベース・ユーザー資格証明の指定]画面では、管理者アカウントであるSYSとSYSTEMのパスワードを設定します。