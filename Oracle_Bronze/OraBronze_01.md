# 第1章 Oracle データベース管理の概要
# 1-1 データベースの基礎知識
## 1-1-1 データベースとは
- **データベース**とは、ある特定の目的に必要なデータを利用しやすく整理し、保管したもの
- データベースの構築や運用には、**データベース管理システム(Database Management System : DBMS)**という専用のソフトウェアを使用する
    - 少量のデータであればExcelでもよいが、多数の従業員が働き、多くのロケーションで利用する場合は、DBMSは必要。
- データベースが備えるべき要件
    - 大量のデータを管理できる
    - データを複数の利用者で共有し、同時に利用できる
    - データを高速に参照・変更でき、パフォーマンスに優れる
    - データが破損したり、障害が発生したりしたときも、速やかに復旧できる(可用性)
    - ユーザごとのアクセスできるデータや実行できる操作が決まっており、不正なアクセスや操作を防止できる(セキュリティ)
## 1-1-2 リレーショナルデータベース
- **リレーショナルデータベース**
    - データを表形式で整理したデータベース
    - **リレーショナルデータベース管理システム**(Relational Database Management System:RDBMS)
- リレーショナルデータベースの表・列・行
    - **表(テーブル)**
        - データを格納する。
        - 2次元表に似た構造をもち、列と行から構成される
        - **行が1件のデータに相当**
        - 列を**カラム**、行を**レコード**と呼ぶ
        - 列には、どのような種類のデータを格納するかを定義する：**データ型**
            - 例えば、注文履歴データの例

            | 列名 | 具体例 |データ型 |
            | --- | --- | --- |
            | order_id | 19-0001 | 文字列型 |
            | order_date | 2019/9/20 19:45:00 |日付型 |
            | dish_name | チキンドリア | 文字列型 |
            | dish_num | 1 | 数値型 |
        - **データ型と異なる種類のデータを列に格納することはできない**
- その他(リレーショナルでない)のデータベース
    - 階層型データベース
        - 下位から上位に向かって要素が束ねられていくタイプの情報
    - ネットワーク型データベース
        - SNSの友人関係のような、データとデータがつながりあうタイプの情報

# 1-2 SQLの基礎知識
## 1-2-1 SQLとは
- **SQL**
    - データベースの表に格納されたデータの参照(問合せ、検索)や変更(追加・更新・削除)を行う際に利用する言語
    - ANSI(アメリカ規格協会)やISO(国際標準化機構)により標準規格が定められている
    - SQLはデータベース(RDBMS)における共通言語である
    - 5種類の機能
        - データ検索
        - データ操作言語
        - データ定義言語
        - トランザクション制御
        - データ制御言語  
            | 分類 | コマンド | 説明 |
            | --- | --- | --- |
            | データ検索 | SELECT | 表に格納された行の参照(問い合わせ、検索) |
            | データ操作言語 (DML) * | INSERT | 表への行の追加(挿入) |
            |  | UPDATE | 表に格納された行の更新 |
            |  | DELETE | 表に格納された行の削除 |
            | データ定義言語 (DDL) | CREATE | オブジェクトの作成 |
            | | DROP | オブジェクトの削除 |
            | | ALTER | オブジェクトの定義変更 |
            | | TRUNCATE | 表に格納されたすべての行を一括削除(切り捨て) |
            | トランザクション制御 | COMMIT | トランザクションの確定 |
            | | ROLLBACK | トランザクションの取り消し |
            | データ制御言語(DCL) | GRANT | 権限の付与 |
            | | REVOKE | 権限の取り消し(剥奪) |
            - DML　：Data Manipulation Language
            - DDL　：Data Definition Language
            - DCL　：Data Control Language

## 1-2-2 SQLコマンドの種類と特徴
### データ検索
- **SELECTコマンドによるデータ参照**
    - menu表にあるすべてのデータを参照する
        ```sql
        SELECT * FROM menu;
        ```
- **WHERE句による検索条件の指定**  
    - menu表にある必要な行だけを参照する
        - メニューから価格をみて、料理名がビーフカレーの行を参照
        ```sql
        SELECT price FROM menu WHERE dish_name = 'ビーフカレー';
        ```
- データへのアクセスパスはRDBMSが自動的に決定する

### データ操作言語(DML)
- **INSERTコマンド**
    - menu表に行を追加する
        - メニューに追加して、カツカレー、900という値を
        ```sql
        INSERT INTO menu VALUES ('カツカレー',900);
        ```
- **DELETEコマンド**
    - menu表から行を削除する
        - メニューから削除して、料理名がビーフカレーの行を
        ```sql
        DELETE FROM menu WHERE dish_name = 'ビーフカレー';
        ```
### データ定義言語(DDL)  
- CREATE：表などのオブジェクトを作成
- DROP：表などのオブジェクトを削除
- ALTER：オブジェクトの定義を変更（表へ列を追加、表から列を削除するなど）
- TRUNCATE：表内のすべての行を削除する
    - DDLの中では、これだけ、処理対象がオブジェクトではなく、データになる
    ```
    DELETE   = 条件にマッチした行を削除
    DROP     = オブジェクトを削除し、表内のすべての行も併せて削除する
    TRUNCATE = 表内のすべての行を削除するが、オブジェクトは残る
    ```

### トランザクション制御
- 処理結果が**中途半端な状態**になることを防止する役割
    - 例えば銀行システム口座A001から口座B002に5000円を移す送金処理
        ```sql
        UPDATE account SET amount = amount - 5000 WHERE account_id = 'A001';
        ```
        ```sql
        UPDATE account SET amount = amount + 5000 WHERE account_id = 'B001';
        ```
        - **どちらか片方の操作が成功し、もう片方の操作が失敗するような中途半端な状態は発生しないようにする必要がある**
        - Oracleはこの2つの処理を**「かたまり」「論理的な作業単位」として扱う
    - 一つでも失敗したら、トランザクション全体が失敗したとみなし、トランザクション実行前に戻す
        - このことを、トランザクションの **原子性(Atomicity)** と呼ぶ
- トランザクションの開始と確定/取り消し
    - トランザクション実行中に**COMMITコマンド**を実行すると、トランザクションが**コミット**され、変更処理が確定する
    - トランザクション実行中に**ROLLBACKコマンド**を実行すると、トランザクションが**ロールバック**され、トランザクション内で実行した変更処理が取り消される
- **暗黙のコミット**
    - トランザクション実行中にDDLコマンドを実行すると、そのDDLコマンドの前に実行していたトランザクションが確定される。
    - DCLでも発生する

### データ制御言語
- **GRANTコマンド**を実行して、ユーザに権限を付与
- **REVOKEコマンド**を実行して、与えた権限を剥奪

# 1-3 Oracle データベースの概要
## 1-3-1 Oracleはクライアント/サーバーシステム
- Oracle専用のデータベースサーバーにOracleをインストールし、アプリケーションが動作する複数のクライアントマシンからネットワークを経由して同時に利用できるシステム構成
- これを**クライアント/サーバーシステム**という

## 1-3-2 Oracleを使用する流れ
- Oracleソフトウェアをインストールする
- Oracleデータベースを作成する
    - **DBCA(Oracle Database Configuration Assistant)** というツールで作成
- アプリケーション用のユーザを作成する
    - 管理用ユーザ(SYS,SYSTEM)でログインして、アプリケーション用のユーザーを作成する
- ユーザに権限を付与する
- 表を作成する・データを読み書きする
    -　SQLを実行するツールとしては、SQL*Plusなどが一般的

## 1-3-3 Oracleデータベース管理者のタスク
| 分類 | タスク | 解説する章 |
| --- | --- | --- |
| セットアップ | Orcleソフトウェアのインストール | 2 |
| | データベースの作成 | 2 |
| | Oracle Network 環境の構成 | 4 |
| 日常的な業務 | リスナーの管理(起動/停止) | 4 |
| | インスタンスの管理(起動停止) | 4 |
| | 表領域の管理 | 5 |
| | ユーザーの管理 | 7 |
| | スキーマオブジェクトの管理 | 8 |
| | データのロード | 8 |
| 障害対策 | パフォーマンスの監視 | 9 |
| | バックアップとリカバリの実行 | 10 |

## 1-3-4 データベース管理ツール
| ツール名 | 機能 | 解説する章 |
| --- | --- | --- |
| Oracle Database Configuration Assistant (DBCA) | データベースの作成、削除およびテンプレートの管理を行う | 2 | 
| Oracle Universal Installer (OUI) | Oracle ソフトウェアのインストールやアンインストールを行う | 2 |
| Database Upgrade Assistant (DBUA) | 古いリリースのデータベースを新しいリリースにアップグレードする | 2 |
| Oracle Enterprise Manager Database Express (EM Express) | Webブラウザの画面からGUI操作でOracleデータベースを管理可能。パフォーマンスの監視、構成管理、診断とチューニングなどを実行できる | 3 |
| Oracle Enterprise Manager Cloud Control | Webブラウザの画面からGUI操作で複数のOracleデータベースを一元的に管理可能。非常に多くの管理作業を実行できる | 3 |
| SQL*Plus | コマンドラインインターフェイスでSQLを実行してOracleデータベースを管理可能 | 3 |
| Oracle Net Manager | Oracleをネットワーク環境で使用するための設定を行う。Oracle Net Configuration Assistant よりも広範な設定をサポートする | 4 |
| Oracle Net Configuration Assistant (NetCA) | Oracleをネットワーク環境で使用するための主要な設定(リスナーやリモート接続の構成など)を行う | 4 |
| リスナー制御ユーティリティ(LSNRCTL) | リスナーの起動/停止を行う | 4 |
| SQL*Loader | CSVファイルなどのデータベース外部にあるファイルのデータを、データベースの表にロードする | 8 |
| Oracle Data Pump | データベース内のデータを別のデータベースに転送する(スキーマ単位でデータをエクスポート/インポート) | 8 |
| Recovery Manger (RMAN) | データベースのバックアップおよび障害発生時の復旧作業(メディアリカバリ)を行う | 10 |
| Oracle Secure Backup | テープバックアップ管理を提供するツール | - |

# 1-4 Oracleデータベースの基本的な動作と構造
## 1-4-1 SQLを実行する処理の流れ
### クライアントとOracleデータベースの接続
- SQL*Plusなどのクライアントアプリケーションを起動すると、**ユーザープロセス**が生成される。ユーザープロセスはクライアントプロセスと呼ばれる。
- ユーザープロセスは、データベースサーバー上で接続要求を待ち受けている**リスナープロセス**に対して、データベースへの接続要求を送る。
- リスナープロセスはユーザープロセスから接続要求を受け取ると、**サーバープロセス**を生成する。サーバープロセスは、ユーザープロセスからの処理要求に対応する役割を持つ。
- 生成されたサーバープロセスは、ユーザープロセスとして接続して、ユーザープロセスの処理要求を待機する

### SQLの処理
- ユーザープロセスが、サーバープロセスにSQLを送信する
- SQLを受け取ったサーバープロセスが、Oracleの内部構造にアクセスしてSQLを実行する
- サーバープロセスが、実行結果をユーザープロセスへ返信する

### 1-4-2 Oracleデータベースの内部構造
| 要素 | 説明 |
| --- | --- |
| インスタンス | Oracleの処理を担う常駐部分のこと。インスタンスが起動していないと、Oracleデータベースは処理を一切実行できない。**システムグローバル領域(SGA : System Global Area)** と**バックグラウンドプロセス** から構成される |
| データベースファイル | データベースを構成するファイル群のこと。**ストレージ装置の記憶域に保存**されている。**データファイル**、**REDOログファイル**、**制御ファイル**がある。データベースファイルのことを単に「データベース」と呼ぶこともある |

# 最強Web
>SQLとその分類の組み合わせについて
- DML : MERGE
    - データのマージ
- DDL : RENAME
    - オブジェクト名の変更
- トランザクション制御 : SAVEPOINT
    - セーブポイントの作成
>Data Pumpの説明として、正しいものは?
- Data Pumpは、データベース間で高速にデータを転送するためのコマンドラインツールです。
- expdpコマンドで移動元データベースからデータをダンプファイルにエクスポートし、impdpコマンドでダンプファイルのデータを移動先データベースにインポートします。
- データのエクスポートはデータベース全体、スキーマ、表領域、表単位で行えます。
- 異なるOSやバージョンのデータベース間でデータを移動できます。

>Oracle Data Guardの説明として正しいものは
- Oracle Data Guardは障害発生時のフェイルオーバー、データ保護を実現する機能です。
- 本番用のプライマリ・データベースとは別に、遠隔地に予備用のスタンバイ・データベースを用意しておき、災害時などプライマリ・データベースが使用できなくなった場合にフェイルオーバーでスタンバイ・データベースに切り替えます。
- Oracle Data Guardは、プライマリ・データベースのREDOデータ(データの変更履歴)をスタンバイ・データベースに転送して適用することによってデータをコピーします。
- また、通常はスタンバイ・データベースを読取り専用で稼働させレポート生成などの処理を行わせることで、負荷分散も実現できます。
>RAC構成において、共有ストレージ用のクラスタファイルシステムとして機能するボリューム・マネージャ及びファイルシステムは
- のちほど
- Oracle Automatic Storage Management
>Oracle Real Application Clustersの説明として正しいものは
- 通常、Oracle Databaseサーバーは1つのOracleデータベースと1つ以上のOracleインスタンスから構成されます。1つのOracleデータベースと1つのOracleインスタンスからなる構成を「シングル・インスタンス構成」といいます。
- 1つのOracleデータベースに対して2つ以上のOracleインスタンスを構成することを「Real Application Clusters構成(RAC構成)」といいます。RACでは異なるサーバー上のインスタンスから共有ストレージのデータベース・ファイルにアクセスします。
>RAC構成において、複数のデータベースサーバーを一群にまとめて動作させるソフトウェアは
- Oracle Clusterware
>SQLに関する説明
- Oracle DatabaseではSQLの実行時、オプティマイザ機能(SQLを実行する際に、最も効率的な実行方法を決定する機能)により、目的のデータに最も高速にアクセスするための方法が自動的に決定されます。