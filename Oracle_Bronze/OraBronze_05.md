# 第5章 Oracleインスタンスの管理
# 5-1 インスタンス
## 5-1-1 インスタンスとは
- **インスタンス**とは、Oracleデータベースのデータ処理の中心となる常駐部分
    - **SGA (System Global Area：システムグローバル領域)** というメモリー領域
    - **バックグラウンドプロセス**
        - CKPTプロセス
        - PMONプロセス　など
### インスタンスとデータベースファイルの対応関係
- １つのインスタンスは、１組のデータベースファイルに対応
    - １つのインスタンスと複数組のデータベースファイルは **×**
    - １組のデータベースファイルと複数のインスタンスは **×**

## 5-1-2 バックグラウンドプロセス
- インスタンス起動時にSGAのメモリ割り当てと併せて起動されるいくつかのプロセスの総称

| プロセス名 | 説明 |
| --- | --- |
| データベースライター（DBWn） | データベースバッファキャッシュ内の更新済みブロックをデータファイルに書き込む |
| ログライター（LGWR） | REDOログファイルのREDOデータ(更新履歴情報)をREOログファイルに書き出す |
| チェックポイント（CKPT） | DBWnに対して、データベースバッファキャッシュ内の更新済みブロックをデータファイル<br>に書き込む指示をだす。制御ファイルにチェックポイント情報を書き込む |
| システムモニター（SMON） | インスタンスが異常終了した場合、次回インスタンス起動時にデータベースファイルの整合性を復旧する処理を実行する |
| プロセスモニター（PMON） | プロセスが異常終了した場合、そのプロセスが使用していた様々なデータやリソースの後処理（クリーンアップ）を実行する |
| 管理モニター（MMON） | 性能分析などで使用される様々な統計情報を定期収集する |
| アーカイバ（ARCN） | ログスイッチの発生後、REDOログファイルのREOデータをアーカイブログファイルとしてコピーする（） |

## 5-1-3 SGA（システムグローバル領域）
- インスタンス起動時に割り当てられるメモリー領域
- プロセス間で共有されるデータが保管される
- 用途に応じたいくつかのメモリー領域があり、これらを**コンポーネント**と呼ぶ

| コンポーネント | 説明 |
| --- | --- |
| データベースバッファキャッシュ | データファイルから読み込んだブロックをキャッシュする。更新済みブロックを一時的に保管する（バッファ機能） |
| 共有プール | 解析済みのSQLやデータディクショナリの情報などをキャッシュする |
| REDOログバッファ | REDOログファイルに書き込む前のREDOデータ（更新履歴）を一時的に保管する |
| Javaプール | Java言語で記述されたストアドプログラムの実行に使用される |
| ラージプール | バックアップや並列処理などの作業領域として使用される |
- ストアドプログラム：プログラムをデータベースに保管し、実行する仕組み

## 5-1-4 データベースバッファキャッシュ
- ブロックの読み出しと書き込み性能を向上させるためのメモリー領域
    - 表や索引のデータは、**ブロック**としてデータファイルに記録される
    - データの参照、書き込みで、**データファイル**とブロックでやりとりをする
### データベースバッファキャッシュのキャッシュ機能
- Oracleで参照処理を実行すると、**サーバープロセス**によりデータファイルからブロックが読みだされる
- この処理をキャッシュ動作で対応

### データベースバッファキャッシュのバッファ機能（遅延書込み）
- データファイルへの書込みを遅延実行する**バッファ**の役割
- データベースバッファキャッシュにある更新済みのブロックは、あとで**データベースライター（DBWn）** によりデータファイルに書き込まれる（**遅延書き込み**）

## 5-1-5 REDOログバッファ
- データベースバッファで保管された状態でインスタンスに障害が発生すると、ブロックの更新が失われる
- 対策として、**REDOデータ**という更新履歴を生成し、REDOログファイルに格納している
- REDOデータは、更新を確定したタイミング（トランザクションをコミットしたタイミング）でREDOファイルに書き込まれる
- 書き込む前のREDOデータを一時的に保管するメモリー領域が**REDOログバッファ**
- REDOログバッファにあるデータをREDOログファイルに書き込む処理を**ログライター（LGWR）プロセス**が実行
- データベースファイルに障害が発生した場合の復旧に利用
- REDOログ・バッファのサイズは静的パラメータである初期化パラメータ「LOG_BUFFER」で決定され、インスタンス起動後には変更できません。REDOログ・バッファのサイズを変更する場合は、初期化パラメータを書き換えた後で、インスタンスを再起動する必要があります。

## 5-1-6 共有プール
- **解析済みSQLの情報**
    - 同一のSQLを実行する場合、共有プールに格納されている解析済みSQLの情報を使用することで、SQLを実行するまでの時間を短縮したり、サーバーにかかる負荷を減らしたりできる。
- **データディクショナリの情報**
    - データベースの内部管理情報のキャッシュ
    - **SYSTEM表領域**

## 5-1-7 PGA（プログラムグローバル領域）
- 特定のOracleプロセス専用のメモリー領域
- プロセス専用のため、プロセス間で共有はされない（SGAとは異なる！）

#  5-2 インスタンスの起動
- インスタンスを起動してから、データベースをオープンするまでのステップ
    - SHUTDOWN
        - インスタンスが停止し、データベースもクローズした状態
    - NOMOUNT
        - インスタンスが起動した状態。SGAが割り当てられ、バックグラウンドプロセスが起動
        - 読み込むファイル：**初期化パラメータファイル**
    - MOUNT
        - 制御ファイルが読み書き可能な状態
        - 読み込むファイル：**制御ファイル**
            - ファイル名は、初期化パラメータファイルに**CONTROL_FILES**初期化パラメータとして格納
            - 複数の制御ファイルがあり、一つでも失敗するとMOUNTに遷移できない
    - OPEN
        - データベースがオープンした状態。REDOログファイルとデータファイルが読み書き可能
        - **REDOログファイル**、**データファイル**
### 起動状態と接続可能なユーザー
- SHUTDOWN/NOMOUNT/MOUNT状態では、特殊な管理権限のユーザーのみデータベースに接続可能
    - SYSDBA
    - SYSOPER
    - SYSBACKUP

### SQL*Plusによるインスタンス起動
- SQL*Plusからインスタンスを起動するには**startup**コマンドを実行
- **SYSDBA権限**または、特殊な管理権限のユーザで実行する必要がある

| コマンド | 説明 |
| --- | --- |
| startup nomount | NOMOUNT状態でインスタンスを起動する。<br>・データベースの手動作成<br>・制御ファイルの再作成 |
| startup mount | Mount状態までインスタンスを起動する。<br>・データファイルの改名、削除<br>・データベースの復旧 |
| startup または startup open | OPEN状態までインスタンスを起動する |

## 5-2-2 初期化パラメータ
- 各メモリー領域のサイズや各機能のON/OFF、プロセスの動作設定など
- **初期化パラメータファイル**
    - パラメータの例

    | パラメータ | 説明 | 起動中の変更 |
    | --- | --- | --- |
    | CONTROL_FILES | 制御ファイルのファイル名。複数指定可能 | ×変更不可 |
    | DISPATCHERS | ディスパッチャプロセスの構成 | 〇変更可 |
    | MEMORY_MAX_TARGET | MEMORY_TARGET初期化パラメータの上限値 | ×変更不可 |
    | MEMORY_TARGET | すべてのSGAコンポーネントと全プロセスのPGAの合計サイズ。<br>自動メモリー管理使用時に設定。 | 〇変更可 |
    | PGA_AGGREGATE_TARGET | 全プロセスのPGAの合計サイズの目標値。自動PGAメモリー管理使用時に設定。 | 〇変更可 |
    | SHARED_POOL_SIZE | 共有プールのサイズ | 〇変更可 |
    | SGA_MAX_SIZE | すべてのSGAコンポーネントの合計サイズの上限値 | ×変更不可 |
    | SGA_TARGET | すべてのSGAコンポーネントの合計サイズ。自動共有メモリー管理使用時に設定する | 〇変更可 |
    | UNDO_RETENTION | UNDO保持の下限値（秒） | 〇変更可 |
    - 起動中に変更可能な初期化パラメータ：**動的初期化パラメータ**
        - **ALTER SYSTEMコマンド**で、インスタンス起動中に変更可
            ```sql
            SQL> show parameter PGA_AGGREGATE_TARGET
 
            NAME                                 TYPE        VALUE
            ------------------------------------ ----------- ------------------------------
            pga_aggregate_target                 big integer 0

            SQL> ALTER SYSTEM SET PGA_AGGREGATE_TARGET=100M;
 
            システムが変更されました。
 
            SQL> show parameter PGA_AGGREGATE_TARGET
 
            NAME                                 TYPE        VALUE
            ------------------------------------ ----------- ------------------------------
            pga_aggregate_target                 big integer 100M
            ```
    - 起動中に変更不可の初期化パラメータ：**静的初期化パラメータ**
        - ALTER SYSTEMコマンドはそのままでは**起動中インスタンスとSPFILE**の両方が変更される
        - 静的の場合は「SCOPE=SPFILE」も加えてコマンドを実行すること
        ```sql
        SQL> show parameter SGA_MAX_SIZE
 
        NAME                                 TYPE        VALUE
        ------------------------------------ ----------- ------------------------------
        sga_max_size                         big integer 680M
                
        
        SQL> ALTER SYSTEM SET SGA_MAX_SIZE=1G;
        ALTER SYSTEM SET SGA_MAX_SIZE=1G
                         *
        行1でエラーが発生しました。:
        ORA-02095: 指定した初期化パラメータを変更できません。

        
        SQL> ALTER SYSTEM SET SGA_MAX_SIZE=1G SCOPE=SPFILE;
 
        システムが変更されました。

        
        SQL> show parameter SGA_MAX_SIZE
 
        NAME                                 TYPE        VALUE
        ------------------------------------ ----------- ------------------------------
        sga_max_size                         big integer 680M
        ```

## 5-2-3 初期化パラメータファイル
- サーバーパラメータファイル（SPFILE）
    - 現在、主に使用される
    - バイナリ形式。ユーザーが直接編集できない
    - 設定値をSQL（ALTER SYSTEMコマンド）で変更可能
- テキスト形式のパラメータファイル（PFILE）
    - テキスト形式。ユーザーがテキストエディタなどで直接編集可能
    - 設定値はSQLで変更不可
- 初期化パラメータファイルは、インスタンスが**NOMOUNT状態**になるときに読まれる
    - SPFILEとPFILEが存在するとき、**SPFILEが優先される**

## 5-2-4 インスタンスの停止
- **shutdown**コマンドを実行する

    | オプション | 説明 | 既存の接続の扱い | 実行中のSQLの扱い |
    | --- | --- | --- | --- |
    | NORMAL | すべての接続が終了するまで待機。デフォルト | ユーザーが接続を終了するまで待機 | 何もしない |
    | TRANSACTIONAL | 実行中のトランザクションが終了するまで待機。 | トランザクション終了時に切断 | トランザクション終了を待機 |
    | IMMEDIATE | 実行中の処理を取り消した上で | 切断 | 取り消す(ロールバック) |
    | ABORT | 実行中の処理を取り消さず、強制的に | 切断 | 強制終了（取り消し処理をせず） |
    - ABORTは次回インスタンス起動時に自動的に回復処理が実施される

# 5-3 メモリーコンポーネントの管理
## 5-3-1 Oracleのメモリーサイズ自動調整機能
- Oracleデータベースが使用するメモリーは**SGA**と**PGA**に大別される
- **SGAとPGAのメモリーサイズを自動的に調整する機能**がある

## 5-3-2 自動メモリー管理
- **自動メモリー管理（AMM：Automatic Memory Management）**
    - SGAとインスタンスPGA（各プロセスのPGAの合計）のサイズを自動的に調整する機能

### 自動メモリー管理の有効化/無効化
- **MEMORY_TARGET**初期化パラメータにSGAとインスタンスPGAの合計サイズを設定
- SGAの各コンポーネントのメモリーサイズも自動調整される
- 自動メモリー管理を無効化するには、MEMORY_TARGETに値を設定しないか、oを設定する

### 自動メモリー管理でのSGA_TARGET
- 自動メモリー管理を使用し、**SGA_TARGET**初期化パラメータに0以外の値を設定した場合、SGA_TARGETの値はSGA全体のメモリーサイズの下限値として使用される

### 自動メモリー管理でのPGA_AGGREGATE_TARGET
- 自動メモリー管理を使用し、**PGA_AGGREGATE_TARGET**初期化パラメータに0以外の値を設定した場合、PGA_AGGREGATE_TARGETの値はSGA全体のメモリーサイズの下限値として使用される

## 5-3-3 自動共有メモリー管理
- ASMM：Automatic Shared Memory Management
- REDOログバッファ以外のSGAの各コンポーネント（共有プールやデータベースバッファキャッシュなど）に割り当てるメモリーのサイズを自動調整する
- 有効化は、SGA_TARGETにSGA全体のサイズを指定する
- 無効化は、自動メモリー管理を無効化したうえで、SGA_TARGETに設定なしor 0の指定
- これを**手動共有メモリー管理**と呼ぶ

| SGAコンポーネント | 初期化パラメータ | 説明 |
| --- | --- | --- |
| REDOログバッファ | LOG_BUFFER | データの変更履歴を保持する |
| データベースバッファキャッシュ | DB_CACHE_SIZE | データファイルから読み込んだデータ・ブロックのコピーを保持する、データ用の作業領域 |
| 共有プール | SHARED_POOL_SIZE | 実行されたSQL文の解析結果や実行計画、データ・ディクショナリの情報を保持 |
| Javaプール | JAVA_POOL_SIZE | Java仮想マシン内のセッション固有のJavaコードやデータを格納する |
| ラージプール | LARGE_POOL_SIZE | Oracle Streamsによって使用される |

## 5-3-4 自動PGAメモリー管理
- **自動PGAメモリー管理**は、**インスタンスPGA**が**PGA_AGGREGATE_TARGET**初期化パラメータの値を超えないよう、各プロセスの自動調整をする機能

>サーバー・プロセスに関する説明と
- サーバー・プロセスはユーザー・プロセスから送信されたSQLを実行するために、Oracle Databaseサーバー側に作成されるプロセスです。
サーバー・プロセスはユーザー・プロセスから受け取ったSQLを解析し、実行計画を作成して、SQLを実行します。SQLの実行後は、結果をユーザー・プロセスへ返します。
SQLの実行時に、データファイルからデータベース・バッファ・キャッシュへデータ・ブロックをコピーしたり、データの変更履歴であるREDOエントリをREDOログ・バッファへ書き込むのもサーバー・プロセスの役割です。
なお、サーバー・プロセスにはその構成により、「専用サーバー・プロセス」と「共有サーバー・プロセス」の2種類があります。

>メモリ管理方法について

| メモリ管理方法 | 説明 | 管理者が指定する初期化パラメータ **太＝動的** |
| --- | --- | --- |
| 自動メモリー管理(AMM) | SGAとインスタンスPGAの合計サイズを指定する<br>指定したサイズ内でSGAとインスタンスPGA間のメモリーサイズが自動調節される | **MEMORY_TARGET**<br>MEMORY_MAX_TARGET |
| 自動共有メモリー管理(ASMM) | SGAの合計サイズを指定する<br>指定したサイズ内でSGAの各コンポーネントのメモリサイズが自動調整される<br>※PGAは自動PGAメモリー管理となる | **SGA_TARGET**<br>SGA_MAX_SIZE |
| 手動共有メモリー管理 | SGAの各コンポーネントのサイズを個別に指定する<br>※PGAは自動PGAメモリー管理となる | **SHARED_POOL_SIZE**<br>**DB_CACHE_SIZE**<br>**LARGE_POOL_SIZE**<br>**JAVA_POOL_SIZE**<br>**STREAMS_POOL_SIZE**<br>LOG_BUFFER |
| 自動PGAメモリー管理 | インスタンスPGAの合計サイズを指定する<br>指定したサイズ内で各PGAのメモリーサイズが自動調整される | **PGA_AGGREGATE_TARGET** |

>SQL*Plusから初期化パラメータの値を変更します。
現在稼働中のインスタンスのみに変更を適用するには、どのコマンドを実行しますか。
なお、インスタンス起動時にはSPFILEを読み込んだものとします。
```sql
ALTER SYSTEM SET memory_target=748M SCOPE=MEMORY
```
