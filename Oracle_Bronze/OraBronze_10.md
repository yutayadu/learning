# 第10章 バックアップ・リカバリの概要と可用性を高める構成
# 10-1 バックアップ・リカバリの概要
## 10-1-1 メディア障害とメディアリカバリ
- メディアリカバリ
    - データベースファイルが破損した場合に実行するデータベースの復旧手段
    - ファイル破損を**メディア障害**と呼ぶ
    - ストレージ装置の異常動作や故障、データベース管理者の作業ミスによるファイル誤削除など
- 基本的には、過去取得したバックアップを戻すことで復旧作業を行う
    - データファイル破損時のメディアリカバリの流れ
        - メディア障害発生前の正常な状態で、データベースのバックアップを取得しておく。<br>取得したバックアップをメディアリカバリで使用する。
        - メディア障害発生時に実行する復旧作業は、バックアップを戻す**リストア**とREDOデータを適用する**リカバリ**から構成される
        - リストアを実行することで、データベースをバックアップ取得時点の状態に戻せる
        - リカバリを実行することで、データベースを障害発生直前の状態にすることができる
- バックアップおよびメディアリカバリは、**Recovery Manager (RMAN)**というツールを使って実行できる

## 10-1-2 ARCHIVELOGモード
- メディアリカバリを行うには、あらかじめデータベースを**ARCHIVELOGモード**で運用する必要がある
    - NOARCHIVELOGモードでは、メディアリカバリはできない
    - ARCHIVELOGモードなら、OPEN中にバックアップを取得できる（**非一貫性バックアップ**）
- このモードに変更すると、REDOログファイル内のREDOデータを含む**アーカイブログファイル**が、指定したディレクトリ以下に出力される（アーカイブ）。この処理はARCn（アーカイバ）プロセスが実行する。
- 手順
    | 項目 | 説明 |
    | --- | --- |
    | 高速リカバリ領域の構成 | ・高速リカバリ領域のサイズと場所を指定する<br>・高速リカバリ領域はアーカイブログファイルを含む、リカバリ関連のファイルを格納するためのストレージ領域 |
    | ARCHIVELOGモードに変更 | ・MOUNTモードでALTER DATABASE ARCHIVELOGコマンドを実行する
- 高速リカバリ領域
    - リカバリ関連ファイルを一元的に管理するためのファイルシステム上の記憶域
    - バックアップファイルやアーカイブログファイルなどのリカバリ関連のファイルを格納
    - 制御ファイル、REDOログファイルの多重化したコピーを配置することもある
    - この領域は必須ではないが、不要なファイルを自動削除できるなどリカバリ関連ファイルの管理が簡素化
    - この領域の実体は**DB_RECOVERY_FILE_DEST**初期化パラメータに記載
    - 11g以前は、**フラッシュリカバリ領域**と呼ばれていた
        | 初期化パラメータ | 説明 |
        | --- | --- |
        | DB_RECOVERY_FILE_DEST | 高速リカバリ領域の場所を指定する |
        | DB_RECOVERY_FILE_DEST_SIZE | 高速リカバリ領域のサイズを指定する |

## 10-1-3 データベースのバックアップ
- **BACKUP DATABASEコマンド**を実行するだけ
```sql
BACKUP DATABASE:
```
- すべてのデータファイルおよび制御ファイル、SPFILEをバックアップ対象とする

### 非一貫性バックアップと一貫性バックアップ
- 非一貫性バックアップ
    - オンラインバックアップ
    - ホットバックアップ
    - 運用としては一般的
- 一貫性バックアップ
    - オフラインバックアップ
    - コールドバックアップ
###  バックアップセット形式とイメージコピー
- バックアップセット（こっちが一般的）
    - RMAN独自のファイル形式
    - 未使用領域の圧縮や暗号化など様々なRMAN拡張機能が利用可能
- イメージコピー
    - バックアップ元のファイルと物理的に同一のコピー
    - バックアップファイルのサイズは、バックアップ元のファイルサイズと同じ

## 10-1-4 リストアとリカバリ
- メディアリカバリ
    - リストア＋リカバリ
        ```sql
        RESTORE DATAFILE '/-/-/.dbf';

        RECOVER DATAFILE '/-/-/.dbf';
        ```
    - recoverコマンド：障害発生直前までデータファイルにREDOデータを適用：**完全リカバリ**

## 10-1-5 バックアップおよびリカバリの実行に必要な権限
- SYSDBA権限
- SYSBACKUP権限
    ```sql
    rman target /

    or

    rman target '"sysbackup/Password123 as sysbackup"'
    ```

## 10-1-6 不完全リカバリ
- 指定した過去のある時点にデータベースを復旧する方法
    - Point-in-Timeリカバリとも呼ぶ

## 10-1-7 メディア障害以外の障害対処
| 障害の種類 | 障害の要因・状況 | 障害発生時の動作および対処方法 |
| --- | --- | --- |
| トランザクション実行中の意図しないセッションの切断 | 誤操作・クライアントアプリの異常終了 | PMONプロセスが実行中トランザクションを**自動的**にロールバックする |
| インスタンスの異常終了 | HW障害、SHUTDOWN ABORTの実行、バグなど | 次回インスタンス起動時、**自動的**にデータベースファイルの整合性を回復する |
| メディア障害 | ディスクドライブやコントローラの障害、操作ミスなどでデータベースファイルが破損 | **管理者が**メディアリカバリをする |
| ユーザーの誤操作によるデータの消失 | 表やデータを誤って変更または削除した | **管理者が**フラッシュバック操作を実行する |

# 10-2 可用性を高める構成
## 10-2-1 Oracleデータベースの重要な用語
- Oracle Real Application Clusters(RAC)
    - 基本の構成は、1つのインスタンスが1組のデータベースファイルを管理
    - **RAC**
        - 複数のデータベースサーバーを連携して動作させることで、障害発生時もサービスを継続させる（クラスタ構成、、
            - 複数のデータベースサーバーを用意し、それぞれのデータベースサーバーにインスタンスを起動する
            - すべてのデータベースファイルを共有ストレージ上に配置し、すべてのデータベースサーバーのインスタンスがこの共有ストレージ上の1つのデータベースにアクセスする
        - ほかの特徴
            - スケールアウト：オンラインでデータベースサーバーを追加
            - キャッシュフュージョン：キャッシュの共有
- Oracle Clusterware
    - RACにおいて、複数のデータベースサーバーを連携して動作するために必要なソフトウェア
- Oracle Automatic Storage Management(ASM)
    - RACにおいて利用する共有ストレージ用ファイルシステム
        - 複数のストレージを統合し、ストレージ管理を簡素化
        - ストライピング：複数ストレージへの並列書き込み、読み込みで性能向上
        - ミラーリング：耐障害性
- Oracle Data GHuard
    - 遠隔地に**スタンバイデータベース**を用意し、耐障害性を高める
        - フィジカルスタンバイデータベース（一般的）
        - ロジカルスタンバイデータベース