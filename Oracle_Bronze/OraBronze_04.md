# 第4章 Oracle Network環境の構成
# 4-1 Oracleデータベースへ接続するソフトウェア
## 4-1-1 Oracle Net
- クライアントコンピュータとデータベースサーバーで必要な作業
    - クライアントコンピュータ
        - Oracleクライアントのインストール
        - Oracle Netの構成
    - データベースサーバー
        - Oracle Netの構成
- Oracle Netを用いたシステム構成は以下
    - 要するに、Webアプリケーションをクライアントとするか否か

| 構成 | 説明 |
| --- | --- |
| クライアント/サーバー型 | ・使用者が操作するコンピュータで動作するツール(アプリ)が、クライアントとしてデータベースに接続する。<br>・クライアントコンピュータにOracleクライアントをインストールする必要がある |
| Webアプリケーション型 | ・Webアプリケーションサーバーで動作するWebアプリケーションが、クライアントとしてデータベースに接続する<br>・WebアプリケーションサーバーにOracleクライアントをインストールする必要がある<br>・使用者が操作するWebクライアント端末でWebブラウザを起動し、Webアプリケーションにアクセスする |

## 4-1-2 リモート接続の全体像
- リモート接続：クライアントがネットワークを介してデータベースに接続すること
- 接続の流れ
    - データベースサーバーでリスナーを起動。リスナーは設定されたポート番号でクライアントからの接続要求を待ち受け、Oracleデータベースに中継する
    - クライアントはリスナーに接続要求を送信。接続要求の送信先は、データベースサーバーのホスト名とリスナーポート番号。
    - 接続を受け付けたリスナーは、クライアントが指定したデータベースサービス名に対応するOracleデータベースに接続を中継し、その結果、クライアントとOracleデータベースの接続が確立される。
### データベースサービス名
- DBCAでデータベースを作成するときに指定した、グローバルデータベース名（データベース名＋ドメイン名）に対応する

## 4-1-3 Oracle Netの構成を支援するツール
- Oracle Netを構成するには、後述のlistener.ora、tnsname.oraなどの設定ファイルの記載が必要
- Oracle Netの構成支援ツール
    - Oracle Net Manager (NETMGR、Net manager)
    - Oracle Net Configuration Assistant (NetCA)
- Oracle Enterprise Manager Cloud ControlからもOracle NEtの構成を実施できる

# 4-2 リスナーの起動/停止と設定
## 4-2-1 リスナーとは
- データベースサーバーで動作し、ネットワークを介した接続の要求を受付、接続要求をOracleデータベースに転送する役割を持つプロセス
- **インスタンスとは別の独立したプロセス**
- 同じデータベースサーバーで動作する複数のOracleデータベースへの接続を受け付けることができる

## 4-2-2 listener.oraによるリスナーの設定
- リスナーの設定は、データベースサーバーの**listener.ora**ファイルに記載
    - リスナーの名前
    - データベースサーバーのホスト名
    - リスナーの接続待ち受けポート番号
    ```bash
    [oracle@localhost admin]$ pwd
    /u01/app/oracle/product/19.0.0/dbhome_1/network/admin
    [oracle@localhost admin]$ cat listener.ora
    # listener.ora Network Configuration File: /u01/app/oracle/product/19.0.0/dbhome_1/network/admin/listener.ora
    # Generated by Oracle configuration tools.
 
    LISTENER =
      (DESCRIPTION =
        (ADDRESS = (PROTOCOL = TCP)(HOST = localhost.localdomain)(PORT = 1521))
      )
 
    ADR_BASE_LISTENER = /u01/app/oracle
    ```
    - listener.oraを直接編集することも可能
    - **Oracle Net Manager**を用いて編集
        - **デフォルトリスナー**
            - リスナー名：LISTENER
            - ポート番号：1521
            - プロトコル：TCP/IP
### 同一データベースサーバー上での複数リスナーの起動
- 接続待ち受けポート番号を変える必要があるが、可能

## 4-2-3 リスナー制御ユーティリティ(lsnctl)を使用した管理
- **リスナー制御ユーティリティ**(lsnrctl)
    - リスナー名を省略するとデフォルトリスナーと解釈される

    | コマンド指定 | 処理内容 |
    | --- | --- |
    | lsnrctl start [リスナー名] | リスナーを起動する |
    | lsnrctl stop [リスナー名] | リスナーを停止する |
    | lsnrctl status [リスナー名] | リスナーの稼働状態と、リスナーが認識しているデータベースサービスを確認する |
    | lsnrctl services [リスナー名] | リスナーの稼働状態と、リスナーが認識しているデータベースサービスの詳細情報を確認する |
    - status
        - リスナーのプロトコル、ホスト名、ポート番号
        - ログファイルの出力先
        - リスナーに登録されているデータベースサービスのサマリー
```bash
$ lsnrctl status
 
LSNRCTL for Linux: Version 19.0.0.0.0 - Production on 29-6月 -2023 07:56:46
Copyright (c) 1991, 2019, Oracle.  All rights reserved.
 
(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=localhost.localdomain)(PORT=1521)))に接続中
リスナーのステータス
------------------------
別名                      LISTENER
バージョン                TNSLSNR for Linux: Version 19.0.0.0.0 - Production
開始日                    29-6月 -2023 03:47:58
稼働時間                  0 日 4 時間 8 分 48 秒
トレース・レベル          off
セキュリティ              ON: Local OS Authentication
SNMP                      OFF
パラメータ・ファイル      /u01/app/oracle/product/19.0.0/dbhome_1/network/admin/listener.ora
ログ・ファイル            /u01/app/oracle/diag/tnslsnr/localhost/listener/alert/log.xml
リスニング・エンドポイントのサマリー...
  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=localhost)(PORT=1521)))
  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcps)(HOST=localhost)(PORT=5500))(Security=(my_wallet_directory=/u01/app/oracle/admin/orcl/xdb_wallet))(Presentation=HTTP)(Session=RAW))
サービスのサマリー...
サービス"orcl"には、1件のインスタンスがあります。
  インスタンス"orcl"、状態READYには、このサービスに対する1件のハンドラがあります...
サービス"orclXDB"には、1件のインスタンスがあります。
  インスタンス"orcl"、状態READYには、このサービスに対する1件のハンドラがあります...
コマンドは正常に終了しました。
```
# 4-3 クライアントからの接続
## 4-3-1 リモート接続と接続識別子
- リモート接続では、ユーザ名とパスワードに加えて、**接続識別子**(ネット・サービス名、またはネットワーク・サービス名)を指定する必要がある

| 接続形態 | SQL*Plusのコマンド書式 |
| --- | --- |
| ローカル接続 | sqlplus ユーザ名/パスワード |
| リモート接続 | sqlplus ユーザ名/パスワード@接続識別子 |

## 4-3-2 ネーミングメソッド
- 接続識別子を接続先情報に解決する方法を**ネーミングメソッド**

| ネーミングメソッド | 解決方法 |
| --- | --- |
| 簡易接続ネーミング | 直接指定<br> host[:port][/service_name] |
| ローカルネーミング | クライアント上の「tnsname.ora」に対応関係を記載 |
| ディレクトリネーミング | LDAP準拠のディレクトリサーバーに対応関係を記載 |
| 外部ネーミング | 外部ネーミングサービスに対応関係を記載 |

## 4-3-3 簡易接続ネーミング
```bash
sqlplus system/system@db.oracle.com:1521/orcl.us.oracle.com
```

## 4-3-4 ローカルネーミング
- **tnsname.ora**
    - 接続識別子＝ネットサービス名(ネット・サービス名、またはネットワーク・サービス名)
    - (DESCRIPTION=(...))を**接続記述子
    ```bash
    orcl =
      (DESCRIPTION =
        (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.21.4)(PORT = 1521))
        (CONNECT_DATA =
          (SERVER = DEDICATED)
          (SERVICE_NAME = localhost.localdomain)
        )
      )
    ```
    ```bsdh
    firewall-cmd --add-port=1521/tcp
    ```
>クライアントからOracle Databaseに接続する際の名前解決に使用するネーミング・メソッドと、その優先順位を指定するファイル
- sqlnet.ora

>サーバー・プロセスの説明
- サーバー・プロセスは、ユーザー・プロセスからの接続要求を受信したリスナー・プロセスによってOracle Databaseサーバー上に生成されます。
サーバー・プロセスとユーザー・プロセスでセッションが確立した後は、ユーザー・プロセスから送信されたSQLを実行し、その結果をユーザー・プロセスへ返します