# 第9章 データベースの監視およびアドバイスの使用
# 9-1 データベースの監視
## 9-1-1 EM Express [データベース・ホーム]ページ
- データベースの状態とワークロードを監視できる
    | セクション | 説明 |
    | --- | --- |
    | ステータス | データベースの状態の概要 |
    | パフォーマンス | アクティブなセッション情報 |
    | リソース | 最新のデータポイント(過去一分間)のリソース使用率 |
    | インシデント | データベース内でのクリティカルエラーの発生 |
    | 実行中のジョブ | 現在実行されているデータベースジョブ |
    | SQL監視 | SQLのアクティビティ |

## 9-1-2 EM Express [パフォーマンス・ハブ]ページ
- 指定した期間に応じたパフォーマンスデータを表示する場合は、**パフォーマンスハブ**を使用する
    - サマリー
        - 指定した期間のシステムのパフォーマンスの包括レビュー
    - アクティビティ
        - アクティブセッション履歴（ASH）分析を表示
    - ワークロード
        - 過去60分間のユーザーコール、解析コール、REDOサイズおよびSQL*Netのパターンをリアルタイムモードで表示
    - 監視対象SQL
        - 選択した期間に実行中であったか完了した監視対象のSQLに関する情報を表示
    - ADDM
        - 選択した期間にデータベース内で実行されたタスクに対してADDMによって検出されたパフォーマンスの結果と推奨事項    
    - コンテナ
        - マルチテナント環境におけるPDBの情報を表示

# 9-2 Oracle自己監視アーキテクチャ
## 9-2-1 AWR（自動ワークロードリポジトリ）
- Oracleデータベースの問題の検出および自己チューニングを目的とし、<br>統計情報とワークロード（処理負荷）情報を自動的に収集・管理する機能
### AWRスナップショット
- AWRにより収集された、ある時点の統計情報とワークロード情報のこと
    - ADDMやアドバイザといった機能の基礎データとして利用される
### AWRスナップショットの保存先/収集間隔/保存期間
- SYSAUX表領域に保存される
- デフォルトでは60分間隔で収集、8日間保存

## 9-2-2 ADDM（自動データベース診断モニター）
- 自己診断エンジン
- Oracleデータベースによってデータベース自身のパフォーマンスが診断され、問題の解決を数値化した効果とともに管理者に推奨する

### AWRスナップショット生成とADDMの実行
- ADDMはAWRスナップショットが生成されるたびに実行される
- 分析結果はSYSAUX表領域内のAWRに格納される

### ADDMの留意点
- ADDMはデータベースがOPENされていない状態で分析は行えない
- ADDMは分析の結果に応じて、アドバイザ機能を実行することがある。ほかのアドバイザからADDMが起動されることはない。
- ADDMは手動で実行することも可能

# 9-3 アドバイザによるパフォーマンスの診断
## 9-3-1 様々なアドバイザ
| アドバイザ | | 機能 |
| --- | --- | --- |
| ADDM | | データベース全体のアドバイスを提供する |
| メモリーアドバイザ | メモリーアドバイザ | 自動メモリー管理モードの場合、<br>インスタンス全体のメモリーを最適化する |
| | PGAアドバイザ | 自動PGAメモリー管理モードの場合、<br>PGA全体のメモリーを最適化する |
| | SGAアドバイザ | 自動共有メモリー管理モードの場合、<br>SGAの構成に関する各コンポーネントサイズを最適化する　|
| | 共有プールアドバイザ | 共有プールの最適サイズを提供する |
| | データバッファキャッシュアドバイザ | データバッファキャッシュの最適サイズを提供する |
| SQLアドバイザ | SQLチューニングアドバイザ | パフォーマンスの向上をさせる推奨項目を作成する<br>(SQLの書き換え、索引作成) |
| | SQLアクセスアドバイザ | SQLを実行する際のアクセスパスに関するチューニングを推奨<br>(索引や待てライズビューの作成) |

## 9-3-2 SQLチューニングアドバイザ
- SQLチューニング・アドバイザは1つまたは複数のSQL文を分析し、SQL文の再構築など、パフォーマンス向上のための推奨事項を作成します。通常、ADDMの診断結果としてこのアドバイザの実行を推奨されます。チューニングの対象となるのは「SELECT文」のみで、その他のDML(INSERTやUPDATE文など)は分析されません。SQLチューニング・アドバイザは、EM Expressから使用できます。
- **実行計画**
    - アクセス経路のことで、**アクセスパス**とも呼ばれる
    - SQLを実行するとき、**オプティマイザ**がSQL実行手順を作成する
        - オプティマイザは、**オプティマイザ統計情報**や**索引**をもとに実行計画を作成する
        - この辺が古いと最善の実行計画が作成できない
### SQLチューニングアドバイザと推奨事項
- 出力される推奨事項
    - オプティマイザ統計の収集
    - 新規索引の作成（**変更はない**）
    - SQLの修正
    - SQLプロファイル（不適切な実行計画が選択された場合の補正情報）の作成・変更
### SQLチューニングアドバイザの入力
- トップアクティビティ
    - 過去一時間に実行されたSQLのうち、問題のありそうなSQLが評価される
- 履歴SQL
    - 24時間単位でSQLをチューニングする
- SQLチューニングセット(STS)
    - AWRスナップショットによって取得されたSQLまたは<br>任意のSQLワークロードから作成された一連のSQLが評価される
        - SQLのセット
        - SQLが実行された状況を示す情報（実行コンテキスト）
        - SQL実行時の実行統計（経過時間、CPU時間、バッファ読み取り、ディスク読み取り、処理された行数）
    - SQLを直接指定して追加することも可能

## 9-3-3 自動SQLチューニングタスク
- SQLチューニングアドバイザを自動的に実行する仕組み
- AWRから負荷の大きい問い合わせを選択し、推奨事項を出力
    - 推奨事項がSQLプロファイルなら、自動的に有効化することも可能
    - それ以外は自動的に有効化はされない

## 9-3-4 SQLアクセスアドバイザ
- パフォーマンスの改善に役立つオブジェクトの構成を推奨する(**作成・変更・削除**)
    - 索引
    - マテリアライズドビュー（SELECT文の実行結果を実データとして持つビュー）
    - パーティション表（表を複数のセグメントに分割する機能）
- SQLワークロードを分析対象とする

### SQLアクセスアドバイザの入力
- 共有プール
- SQLチューニングセット：指定した一連のSQL文を分析する
- 仮想ワークロード
